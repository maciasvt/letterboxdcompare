<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Letterboxd Compare</title>
<style>
  body {
    background:#142428; color:#fff;
    font-family: Roboto, sans-serif;
    margin:0; padding:20px;
    display:flex; flex-direction: column; align-items:center;
  }
  h1 {
    font-size: 2rem;
    margin-bottom: 1rem;
  }
  .inputs {
    display:flex;
    flex-direction: column;
    gap: 10px;
    width: 90vw;
    max-width: 400px;
    margin-bottom: 1rem;
  }
  input[type="text"] {
    padding: 10px;
    font-size: 1.1rem;
    border-radius: 6px;
    border: none;
  }
  button {
    padding: 12px;
    font-size: 1.2rem;
    background: #00ac1c;
    border: none;
    border-radius: 6px;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background: #007a0b;
  }
  #results {
    display: none;
    width: 90vw;
    max-width: 420px;
    margin-top: 1rem;
    color: black;
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-sizing: border-box;
    font-size: 0.9rem;
  }
  .section {
    margin-bottom: 1rem;
  }
  .section h2 {
    margin: 0 0 0.5rem 0;
    color: #142428;
    font-weight: 700;
    font-size: 1.1rem;
  }
  .data-box {
    max-height: 150px;
    overflow-y: auto;
    white-space: pre-wrap;
    background: #eee;
    border-radius: 6px;
    padding: 10px;
    color: #333;
    font-family: monospace;
  }
</style>
</head>
<body>

<h1>Letterboxd Compare</h1>

<div class="inputs">
  <input id="username1" type="text" placeholder="User 1" />
  <input id="username2" type="text" placeholder="User 2" />
  <button id="compareBtn" onclick="construirUrlYExtraer()">Compare profiles!</button>
</div>

<div id="results">
  <div class="section">
    <h2 id="labelSlugs1">Last seen by: </h2>
    <div id="filmSlugs1" class="data-box"></div>
  </div>
  <div class="section">
    <h2 id="labelSlugs2">Last seen by: </h2>
    <div id="filmSlugs2" class="data-box"></div>
  </div>
  <div class="section">
    <h2 id="labelWatchlistSlugs1"></h2>
    <div id="watchlistSlugs1" class="data-box"></div>
  </div>
  <div class="section">
    <h2 id="labelWatchlistSlugs2"></h2>
    <div id="watchlistSlugs2" class="data-box"></div>
  </div>
  <div class="section">
    <h2 id="labelFilmCompare">Seen by both + ratings</h2>
    <div id="filmCompare" class="data-box"></div>
  </div>
  <div class="section">
    <h2 id="labelWatchlistCompare">In both watchlists</h2>
    <div id="watchlistCompare" class="data-box"></div>
  </div>
  <div class="section">
    <h2 id="labelUniqueFilms1"></h2>
    <div id="filmSlugs3" class="data-box"></div>
  </div>
  <div class="section">
    <h2 id="labelUniqueFilms2"></h2>
    <div id="filmSlugs4" class="data-box"></div>
  </div>
</div>

<script>
  let username1 = '';
  let username2 = '';
  let filmsUser1 = [];
  let filmsUser2 = [];
  let watchlistUser1 = [];
  let watchlistUser2 = [];

  async function construirUrlYExtraer() {
    username1 = document.getElementById('username1').value.trim();
    username2 = document.getElementById('username2').value.trim();

    if(!username1 || !username2) {
      alert("Por favor ingresa ambos usuarios.");
      return;
    }

    document.getElementById('results').style.display = 'none';

    const url1 = `https://letterboxd.com/${encodeURIComponent(username1)}/films`;
    const url2 = `https://letterboxd.com/${encodeURIComponent(username2)}/films`;
    const wlUrl1 = `https://letterboxd.com/${encodeURIComponent(username1)}/watchlist/`;
    const wlUrl2 = `https://letterboxd.com/${encodeURIComponent(username2)}/watchlist/`;

    try {
      [filmsUser1, filmsUser2, watchlistUser1, watchlistUser2] = await Promise.all([
        fetchFilms(url1),
        fetchFilms(url2),
        fetchWatchlist(wlUrl1),
        fetchWatchlist(wlUrl2)
      ]);
      mostrarResultados();
    } catch (e) {
      alert("Error al obtener datos. Ver consola.");
      console.error(e);
    }
  }

  async function fetchFilms(url) {
    let films = [];
    const resp = await fetch(`/extraer?url=${encodeURIComponent(url)}`);
    const html = await resp.text();
    const pages = getTotalPages(html);
    films = films.concat(parseFilms(html));

    for(let i=2; i<=pages; i++) {
      const pageUrl = `${url}/page/${i}/`;
      const r = await fetch(`/extraer?url=${encodeURIComponent(pageUrl)}`);
      const h = await r.text();
      films = films.concat(parseFilms(h));
    }
    return films;
  }

  async function fetchWatchlist(url) {
    let wl = [];
    const resp = await fetch(`/extraer?url=${encodeURIComponent(url)}`);
    const html = await resp.text();
    const pages = getTotalPages(html);
    wl = wl.concat(parseWatchlist(html));

    for(let i=2; i<=pages; i++) {
      const pageUrl = `${url}/page/${i}/`;
      const r = await fetch(`/extraer?url=${encodeURIComponent(pageUrl)}`);
      const h = await r.text();
      wl = wl.concat(parseWatchlist(h));
    }
    return wl;
  }

  function getTotalPages(html) {
    const temp = document.createElement('div');
    temp.innerHTML = html;
    const pages = temp.querySelectorAll('.paginate-page');
    return pages.length ? Number(pages[pages.length -1].textContent) : 1;
  }

  function parseFilms(html) {
    const temp = document.createElement('div');
    temp.innerHTML = html;
    const elements = temp.querySelectorAll('[data-film-slug]');
    let arr = [];
    elements.forEach(el => {
      const slug = el.getAttribute('data-film-slug');
      let rating = "N/A";
      try {
        const ratingEl = el.closest('.poster-container')?.querySelector('.poster-viewingdata .rating');
        if(ratingEl){
          const m = ratingEl.className.match(/rated-(\d+)/);
          if(m) rating = m[1];
        }
      } catch(e){}
      arr.push({slug, rating});
    });
    return arr;
  }

  function parseWatchlist(html) {
    const temp = document.createElement('div');
    temp.innerHTML = html;
    const elements = temp.querySelectorAll('[data-film-slug]');
    return Array.from(elements).map(el => ({slug: el.getAttribute('data-film-slug')}));
  }

  function mostrarResultados(){
    // Actualiza labels con nombres de usuario
    document.getElementById('labelSlugs1').textContent = `Last seen by: ${username1}`;
    document.getElementById('labelSlugs2').textContent = `Last seen by: ${username2}`;
    document.getElementById('labelWatchlistSlugs1').textContent = `${username1}'s Watchlist`;
    document.getElementById('labelWatchlistSlugs2').textContent = `${username2}'s Watchlist`;

    // Mostrar películas vistas (todas incluyendo N/A)
    document.getElementById('filmSlugs1').textContent = filmsUser1.map(f => formatFilmSlug(f.slug, f.rating)).join('\n');
    document.getElementById('filmSlugs2').textContent = filmsUser2.map(f => formatFilmSlug(f.slug, f.rating)).join('\n');

    // Mostrar watchlists
    document.getElementById('watchlistSlugs1').textContent = watchlistUser1.map(f => formatSlug(f.slug)).join('\n');
    document.getElementById('watchlistSlugs2').textContent = watchlistUser2.map(f => formatSlug(f.slug)).join('\n');

    // Seen by both con rating válido (sin N/A)
    const rated1 = filmsUser1.filter(f => f.rating !== "N/A");
    const rated2 = filmsUser2.filter(f => f.rating !== "N/A");
    const seenBothRated = rated1.filter(f1 => rated2.some(f2 => f2.slug === f1.slug))
      .map(f1 => {
        const f2 = rated2.find(x => x.slug === f1.slug);
        return {slug: f1.slug, rating1: parseInt(f1.rating), rating2: parseInt(f2.rating)};
      });
    seenBothRated.sort((a,b) => Math.abs(b.rating1 - b.rating2) - Math.abs(a.rating1 - a.rating2));
    document.getElementById('filmCompare').textContent = seenBothRated.length ? seenBothRated.map(f => `${formatSlug(f.slug)} - Ratings: ${f.rating1} | ${f.rating2}`).join('\n') : 'No se encontraron coincidencias con rating.';

    // Watchlist matches
    const wl1 = watchlistUser1.map(w => w.slug);
    const wl2 = watchlistUser2.map(w => w.slug);
    const wlMatches = wl1.filter(s => wl2.includes(s));
    document.getElementById('watchlistCompare').textContent = wlMatches.length ? wlMatches.map(formatSlug).join('\n') : 'No se encontraron coincidencias en las watchlists.';

    // Únicos vistos (incluye N/A) por usuario 1 que usuario 2 no tiene
    const unique1 = filmsUser1.filter(f1 => !filmsUser2.some(f2 => f2.slug === f1.slug));
    const unique2 = filmsUser2.filter(f2 => !filmsUser1.some(f1 => f1.slug === f2.slug));
    document.getElementById('labelUniqueFilms1').textContent = `Seen by ${username1} not by ${username2}`;
    document.getElementById('labelUniqueFilms2').textContent = `Seen by ${username2} not by ${username1}`;
    document.getElementById('filmSlugs3').textContent = unique1.length ? unique1.map(f => `${formatSlug(f.slug)} - Rating: ${f.rating}`).join('\n') : `No hay películas vistas por ${username1} que no haya visto ${username2}.`;
    document.getElementById('filmSlugs4').textContent = unique2.length ? unique2.map(f => `${formatSlug(f.slug)} - Rating: ${f.rating}`).join('\n') : `No hay películas vistas por ${username2} que no haya visto ${username1}.`;

    // Mostrar resultados
    document.getElementById('results').style.display = 'block';
  }

  function formatFilmSlug(slug, rating) {
    return `${formatSlug(slug)} - Rating: ${rating}`;
  }

  function formatSlug(slug) {
    return slug.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
  }
</script>

</body>
</html>
