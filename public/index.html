<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Letterboxd Compare</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

    <style>
        * { box-sizing: border-box; }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
            background-color: #142428;
            font-family: "Roboto", sans-serif;
            padding: 12px;
            margin: 0;
        }

        h1 {
            text-align: center;
            margin-bottom: 16px;
            font-size: 2.2rem;
        }

        .container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 16px;
            width: 100%;
            max-width: 900px;
        }

        input {
            font-size: 1.1rem;
            padding: 10px;
            flex: 1 1 200px;
            min-width: 150px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        button {
            font-size: 1.1rem;
            background-color: #00ac1c;
            color: white;
            transition: background-color 0.25s, transform 0.15s;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            margin-bottom: 12px;
            cursor: pointer;
        }
        button:hover { background-color: #007a0b; transform: translateY(-2px); }

        .film-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            width: 100%;
            max-width: 1200px;
            margin-bottom: 12px;
        }

        /* Labels: ocultos inicialmente */
        .label {
            display: none;
            text-align: center;
            flex: 1 1 100%;
            margin: 6px 0;
            color: #e6f0ea;
        }

        /* Contenedores de resultados: ocultos inicialmente */
        #filmSlugs1, #filmSlugs2,
        #filmCompare, #watchlistSlugs1,
        #watchlistSlugs2, #watchlistCompare,
        #filmSlugs3, #filmSlugs4 {
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
            white-space: pre-wrap;
            flex: 1 1 300px;
            max-height: 220px;
            background-color: white;
            color: black;
            font-size: 0.95rem;
            display: none; /* <- oculto por defecto */
            border-radius: 6px;
        }

        /* Ocultar output de c칩digo (si se usa) */
        #codeOutput { display: none; }

        /* Responsive ajustes */
        @media (max-width: 768px) {
            h1 { font-size: 1.6rem; }
            button { font-size: 1rem; padding: 8px 12px; }
            input { font-size: 1rem; }
            #filmSlugs1, #filmSlugs2, #filmCompare,
            #watchlistSlugs1, #watchlistSlugs2,
            #watchlistCompare, #filmSlugs3, #filmSlugs4 {
                max-height: 160px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <h1>Letterboxd Compare</h1>

    <div class="container">
        <input type="text" id="username1" placeholder="User 1" />
        <input type="text" id="username2" placeholder="User 2" />
    </div>

    <button onclick="construirUrlYExtraer()">Compare profiles!</button>

    <!-- Labels y contenedores (todos ocultos inicialmente via .label o display:none) -->
    <div class="film-container">
        <h2 id="labelSlugs1" class="label">Last seen by :</h2>
        <h2 id="labelSlugs2" class="label">Last seen by :</h2>
    </div>

    <div class="film-container">
        <div id="filmSlugs1"></div>
        <div id="filmSlugs2"></div>
    </div>

    <h2 id="labelFilmCompare" class="label">Seen by both + ratings:</h2>
    <div id="filmCompare"></div>

    <h2 id="labelUniqueFilms1" class="label"></h2>
    <div id="filmSlugs3"></div>

    <h2 id="labelUniqueFilms2" class="label"></h2>
    <div id="filmSlugs4"></div>

    <div class="film-container">
        <h2 id="labelWatchlistSlugs1" class="label">Watchlist:</h2>
        <h2 id="labelWatchlistSlugs2" class="label">Watchlist:</h2>
    </div>

    <div class="film-container">
        <div id="watchlistSlugs1"></div>
        <div id="watchlistSlugs2"></div>
    </div>

    <h2 id="labelWatchlistCompare" class="label">In both watchlists:</h2>
    <div id="watchlistCompare"></div>

    <pre id="codeOutput"></pre>

    <script>
        let username1 = '';
        let username2 = '';

        function construirUrlYExtraer() {
            username1 = document.getElementById('username1').value.trim();
            username2 = document.getElementById('username2').value.trim();

            // Actualizar encabezados din치micamente (se mostrar치n al extraer)
            document.getElementById('labelSlugs1').textContent = `Last seen by : ${username1}`;
            document.getElementById('labelSlugs2').textContent = `Last seen by : ${username2}`;
            document.getElementById('labelWatchlistSlugs1').textContent = `${username1}'s Watchlist`;
            document.getElementById('labelWatchlistSlugs2').textContent = `${username2}'s Watchlist`;

            const url1 = `https://letterboxd.com/${username1}/films`;
            const url2 = `https://letterboxd.com/${username2}/films`;
            const watchlistUrl1 = `https://letterboxd.com/${username1}/watchlist/`;
            const watchlistUrl2 = `https://letterboxd.com/${username2}/watchlist/`;

            // Llamadas en paralelo
            Promise.all([
                extraerHtml(url1, 'filmSlugs1').then(() => {
                    document.getElementById('labelSlugs1').style.display = 'block';
                }),
                extraerHtml(url2, 'filmSlugs2').then(() => {
                    document.getElementById('labelSlugs2').style.display = 'block';
                }),
                extraerHtmlWatchlist(watchlistUrl1, 'watchlistSlugs1').then(() => {
                    document.getElementById('labelWatchlistSlugs1').style.display = 'block';
                }),
                extraerHtmlWatchlist(watchlistUrl2, 'watchlistSlugs2').then(() => {
                    document.getElementById('labelWatchlistSlugs2').style.display = 'block';
                })
            ]).then(() => {
                compararFilms();
                compararWatchlists();
                compararFilmsUnicos();
            }).catch(err => {
                console.error("Error en extracci칩n:", err);
            });
        }

        async function extraerHtml(url, slugsContainerId) {
            const response = await fetch(`/extraer?url=${encodeURIComponent(url)}`);
            const html = await response.text();
            const totalPages = encontrarTotalPaginas(html);
            let filmData = extraerSlugsConCalificacion(html);

            if (totalPages > 1) {
                for (let i = 2; i <= totalPages; i++) {
                    const pageUrl = `${url}/page/${i}/`;
                    const pageResponse = await fetch(`/extraer?url=${encodeURIComponent(pageUrl)}`);
                    const pageHtml = await pageResponse.text();
                    filmData = filmData.concat(extraerSlugsConCalificacion(pageHtml));
                }
            }
            document.getElementById(slugsContainerId).textContent = filmData.map(film => formatFilmSlug(film.slug, film.rating)).join('\n');
            document.getElementById(slugsContainerId).style.display = 'block';
        }

        async function extraerHtmlWatchlist(url, slugsContainerId) {
            const response = await fetch(`/extraer?url=${encodeURIComponent(url)}`);
            const html = await response.text();
            const totalPages = encontrarTotalPaginas(html);
            let watchlistData = extraerSlugsWatchlist(html);

            if (totalPages > 1) {
                for (let i = 2; i <= totalPages; i++) {
                    const pageUrl = `${url}/page/${i}/`;
                    const pageResponse = await fetch(`/extraer?url=${encodeURIComponent(pageUrl)}`);
                    const pageHtml = await pageResponse.text();
                    watchlistData = watchlistData.concat(extraerSlugsWatchlist(pageHtml));
                }
            }
            document.getElementById(slugsContainerId).textContent = watchlistData.map(film => formatSlug(film.slug)).join('\n');
            document.getElementById(slugsContainerId).style.display = 'block';
        }

        function encontrarTotalPaginas(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const paginacion = tempDiv.querySelectorAll('.paginate-page');
            const totalPageNumber = paginacion.length > 0 ? paginacion[paginacion.length - 1].textContent : "1";
            return parseInt(totalPageNumber, 10) || 1;
        }

        function extraerSlugsConCalificacion(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const elementos = tempDiv.querySelectorAll('[data-film-slug]');
            let filmData = [];
            elementos.forEach(elemento => {
                const filmSlug = elemento.getAttribute('data-film-slug');
                const ratingElement = elemento.closest('.poster-container') ? elemento.closest('.poster-container').querySelector('.poster-viewingdata .rating') : null;
                const rating = ratingElement ? (ratingElement.className.match(/rated-(\d+)/) || [null, "N/A"])[1] : "N/A";
                filmData.push({ slug: filmSlug, rating: rating });
            });
            return filmData;
        }

        function extraerSlugsWatchlist(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const elementos = tempDiv.querySelectorAll('[data-film-slug]');
            let watchlistData = [];
            elementos.forEach(elemento => {
                const filmSlug = elemento.getAttribute('data-film-slug');
                watchlistData.push({ slug: filmSlug });
            });
            return watchlistData;
        }

        function compararFilms() {
            const films1 = document.getElementById('filmSlugs1').textContent.split('\n').map(line => {
                const parts = line.split(' - ');
                return { slug: parts[0].trim(), rating: parts.length > 1 ? parts[1].replace('Rating: ', '').trim() : "N/A" };
            }).filter(film => film.rating !== "N/A");

            const films2 = document.getElementById('filmSlugs2').textContent.split('\n').map(line => {
                const parts = line.split(' - ');
                return { slug: parts[0].trim(), rating: parts.length > 1 ? parts[1].replace('Rating: ', '').trim() : "N/A" };
            }).filter(film => film.rating !== "N/A");

            const coincidencias = films1.filter(film1 => films2.some(film2 => film2.slug === film1.slug))
                .map(film1 => {
                    const film2 = films2.find(f => f.slug === film1.slug);
                    return { slug: film1.slug, rating1: parseInt(film1.rating), rating2: parseInt(film2.rating) };
                });

            coincidencias.sort((a, b) => (b.rating1 - b.rating2) - (a.rating1 - a.rating2));

            const coincidenciasFormateadas = coincidencias.map(film => `${film.slug} - Ratings: ${film.rating1} | ${film.rating2}`);
            document.getElementById('filmCompare').textContent = coincidenciasFormateadas.length > 0 ? coincidenciasFormateadas.join('\n') : "No se encontraron coincidencias.";
            document.getElementById('filmCompare').style.display = 'block';
            document.getElementById('labelFilmCompare').style.display = 'block';
        }

        function compararWatchlists() {
            const watchlist1 = document.getElementById('watchlistSlugs1').textContent.split('\n').map(slug => slug.trim()).filter(slug => slug !== "");
            const watchlist2 = document.getElementById('watchlistSlugs2').textContent.split('\n').map(slug => slug.trim()).filter(slug => slug !== "");

            const coincidenciasWatchlist = watchlist1.filter(slug1 => watchlist2.includes(slug1));
            document.getElementById('watchlistCompare').textContent = coincidenciasWatchlist.length > 0 ? coincidenciasWatchlist.map(slug => formatSlug(slug)).join('\n') : "No se encontraron coincidencias en las watchlists.";
            document.getElementById('watchlistCompare').style.display = 'block';
            document.getElement
