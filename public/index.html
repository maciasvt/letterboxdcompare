<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Letterboxd Compare</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg: #142428;
    --accent: #00ac1c;
    --accent-dark: #007a0b;
    --card-bg: #fff;
    --card-text: #111;
    --max-width: 420px;
  }
  html,body{
    height:100%;
    margin:0;
    padding:0;
    font-family:"Roboto",sans-serif;
    background:var(--bg);
    color:#fff;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }
  .wrap{
    box-sizing:border-box;
    width:100%;
    max-width:var(--max-width);
    margin:0 auto;
    padding:18px;
    display:flex;
    flex-direction:column;
    gap:14px;
  }
  h1{
    margin:0;
    font-size:20px;
    text-align:center;
    font-weight:700;
  }
  .inputs {
    display:flex;
    flex-direction:column;
    gap:10px;
    width:100%;
  }
  input[type="text"]{
    width:100%;
    padding:12px;
    font-size:15px;
    border-radius:8px;
    border:none;
    outline:none;
    box-shadow: 0 1px 0 rgba(255,255,255,0.03) inset;
  }
  button#compareBtn{
    width:100%;
    padding:12px;
    font-size:16px;
    border-radius:8px;
    border:none;
    background:var(--accent);
    color:#fff;
    cursor:pointer;
    transition:transform .12s ease, background-color .18s ease;
  }
  button#compareBtn:active{ transform:translateY(1px); }
  button#compareBtn:hover{ background:var(--accent-dark); }
  .results {
    display:none;
    width:100%;
    flex-direction:column;
    gap:12px;
  }
  .user-section{
    display:flex;
    flex-direction:column;
    gap:8px;
    width:100%;
  }
  .section-title{
    color:#cfe6d0;
    font-weight:700;
    font-size:13px;
    margin:0;
  }
  .data-box{
    background:var(--card-bg);
    color:var(--card-text);
    padding:10px;
    border-radius:8px;
    font-size:13px;
    line-height:1.4;
    max-height:180px;
    overflow:auto;
    white-space:pre-wrap;
    word-break:break-word;
    box-shadow: 0 2px 6px rgba(0,0,0,0.12);
  }
  .compare-block{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  @media (max-width:360px){
    .wrap{ padding:12px; }
    input[type="text"]{ padding:10px; font-size:14px; }
    button#compareBtn{ padding:10px; font-size:15px; }
    .data-box{ font-size:13px; }
  }
  .small-muted{
    color:#99b3a6;
    font-size:12px;
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Letterboxd Compare</h1>

  <div class="inputs" id="controls">
    <input id="username1" type="text" placeholder="User 1 (ej. juan123)" autocomplete="username" />
    <input id="username2" type="text" placeholder="User 2 (ej. maria456)" autocomplete="username" />
    <button id="compareBtn" onclick="construirUrlYExtraer()">Compare profiles!</button>
  </div>

  <div id="results" class="results">

    <div class="user-section" id="user1Section">
      <span id="labelSlugs1" class="section-title">Last seen by: </span>
      <div id="filmSlugs1" class="data-box"></div>
      <span id="labelWatchlistSlugs1" class="section-title">Watchlist</span>
      <div id="watchlistSlugs1" class="data-box"></div>
    </div>

    <div class="user-section" id="user2Section">
      <span id="labelSlugs2" class="section-title">Last seen by: </span>
      <div id="filmSlugs2" class="data-box"></div>
      <span id="labelWatchlistSlugs2" class="section-title">Watchlist</span>
      <div id="watchlistSlugs2" class="data-box"></div>
    </div>

    <div class="compare-block">
      <span id="labelFilmCompare" class="section-title">Seen by both + ratings</span>
      <div id="filmCompare" class="data-box"></div>

      <span id="labelWatchlistCompare" class="section-title">In both watchlists</span>
      <div id="watchlistCompare" class="data-box"></div>
    </div>

    <div class="compare-block">
      <span id="labelUniqueFilms1" class="section-title">Seen by User 1 not by User 2</span>
      <div id="filmSlugs3" class="data-box"></div>

      <span id="labelUniqueFilms2" class="section-title">Seen by User 2 not by User 1</span>
      <div id="filmSlugs4" class="data-box"></div>
    </div>

    <div class="compare-block">
      <span id="labelNAUser1NotUser2" class="section-title">Seen by User 1 N/A and not seen by User 2</span>
      <div id="filmSlugsNA" class="data-box"></div>
    </div>

    <div class="small-muted">Resultados cargados desde tu endpoint <code>/extraer?url=...</code></div>
  </div>
</div>

<script>
  let filmsUser1 = [];
  let filmsUser2 = [];
  let watchlistUser1 = [];
  let watchlistUser2 = [];
  let username1 = '';
  let username2 = '';

  async function construirUrlYExtraer(){
    username1 = document.getElementById('username1').value.trim();
    username2 = document.getElementById('username2').value.trim();

    if(!username1 || !username2){
      alert('Ingresa ambos usuarios antes de comparar.');
      return;
    }

    document.getElementById('results').style.display = 'none';
    showLoadingState(true);

    const url1 = `https://letterboxd.com/${encodeURIComponent(username1)}/films`;
    const url2 = `https://letterboxd.com/${encodeURIComponent(username2)}/films`;
    const watchlistUrl1 = `https://letterboxd.com/${encodeURIComponent(username1)}/watchlist/`;
    const watchlistUrl2 = `https://letterboxd.com/${encodeURIComponent(username2)}/watchlist/`;

    try {
      const [f1, f2, wl1, wl2] = await Promise.all([
        extraerHtml(url1),
        extraerHtml(url2),
        extraerHtmlWatchlist(watchlistUrl1),
        extraerHtmlWatchlist(watchlistUrl2)
      ]);

      filmsUser1 = f1; filmsUser2 = f2;
      watchlistUser1 = wl1; watchlistUser2 = wl2;

      renderResults();
    } catch (err) {
      console.error(err);
      alert('Ocurrió un error al extraer los datos. Revisa la consola y el endpoint /extraer.');
    } finally {
      showLoadingState(false);
    }
  }

  function showLoadingState(isLoading){
    const btn = document.getElementById('compareBtn');
    btn.disabled = isLoading;
    btn.textContent = isLoading ? 'Loading...' : 'Compare profiles!';
  }

  async function extraerHtml(url){
    const resp = await fetch(`/extraer?url=${encodeURIComponent(url)}`);
    const html = await resp.text();
    const totalPages = encontrarTotalPaginas(html);
    let filmData = extraerSlugsConCalificacion(html);

    if(totalPages > 1){
      for(let i=2;i<=totalPages;i++){
        const pageUrl = `${url}/page/${i}/`;
        const pageResp = await fetch(`/extraer?url=${encodeURIComponent(pageUrl)}`);
        const pageHtml = await pageResp.text();
        filmData = filmData.concat(extraerSlugsConCalificacion(pageHtml));
      }
    }
    return filmData;
  }

  async function extraerHtmlWatchlist(url){
    const resp = await fetch(`/extraer?url=${encodeURIComponent(url)}`);
    const html = await resp.text();
    const totalPages = encontrarTotalPaginas(html);
    let wl = extraerSlugsWatchlist(html);

    if(totalPages > 1){
      for(let i=2;i<=totalPages;i++){
        const pageUrl = `${url}/page/${i}/`;
        const pageResp = await fetch(`/extraer?url=${encodeURIComponent(pageUrl)}`);
        const pageHtml = await pageResp.text();
        wl = wl.concat(extraerSlugsWatchlist(pageHtml));
      }
    }
    return wl;
  }

  function encontrarTotalPaginas(html){
    const temp = document.createElement('div');
    temp.innerHTML = html;
    const pages = temp.querySelectorAll('.paginate-page');
    return pages.length > 0 ? parseInt(pages[pages.length-1].textContent,10) : 1;
  }

  function extraerSlugsConCalificacion(html){
    const temp = document.createElement('div');
    temp.innerHTML = html;
    const elementos = temp.querySelectorAll('[data-film-slug]');
    const arr = [];
    elementos.forEach(el => {
      const slug = el.getAttribute('data-film-slug');
      let ratingNode = null;
      try {
        ratingNode = el.closest('.poster-container')?.querySelector('.poster-viewingdata .rating');
      } catch(e) { ratingNode = null; }
      const ratingMatch = ratingNode ? (ratingNode.className.match(/rated-(\d+)/) || null) : null;
      const rating = ratingMatch ? ratingMatch[1] : "N/A";
      arr.push({ slug, rating });
    });
    return arr;
  }

  function extraerSlugsWatchlist(html){
    const temp = document.createElement('div');
    temp.innerHTML = html;
    const elementos = temp.querySelectorAll('[data-film-slug]');
    return Array.from(elementos).map(e => ({ slug: e.getAttribute('data-film-slug') }));
  }

  function renderResults(){
    document.getElementById('labelSlugs1').textContent = `Last seen by: ${username1}`;
    document.getElementById('labelSlugs2').textContent = `Last seen by: ${username2}`;
    document.getElementById('labelWatchlistSlugs1').textContent = `${username1}'s Watchlist`;
    document.getElementById('labelWatchlistSlugs2').textContent = `${username2}'s Watchlist`;

    // Vistos para ambos usuarios (incluye N/A que sí cuentan como vistas)
    const seenUser1 = filmsUser1; // NO filtramos N/A, cuentan como vistas
    const seenUser2 = filmsUser2;

    document.getElementById('filmSlugs1').textContent = seenUser1.length ? seenUser1.map(f => formatFilmSlug(f.slug, f.rating)).join('\n') : 'No hay películas vistas.';
    document.getElementById('filmSlugs2').textContent = seenUser2.length ? seenUser2.map(f => formatFilmSlug(f.slug, f.rating)).join('\n') : 'No hay películas vistas.';

    // Watchlists
    document.getElementById('watchlistSlugs1').textContent = watchlistUser1.length ? watchlistUser1.map(s => formatSlug(s.slug)).join('\n') : 'Watchlist vacía.';
    document.getElementById('watchlistSlugs2').textContent = watchlistUser2.length ? watchlistUser2.map(s => formatSlug(s.slug)).join('\n') : 'Watchlist vacía.';

    // Seen by both con rating válido (sin N/A)
    const ratedUser1 = seenUser1.filter(f => f.rating !== 'N/A');
    const ratedUser2 = seenUser2.filter(f => f.rating !== 'N/A');

    const seenByBothRated = ratedUser1.filter(s1 => ratedUser2.some(s2 => s2.slug === s1.slug))
      .map(s1 => {
        const s2 = ratedUser2.find(s => s.slug === s1.slug);
        return { slug: s1.slug, rating1: parseInt(s1.rating,10), rating2: parseInt(s2.rating,10) };
      });
    seenByBothRated.sort((a,b) => Math.abs(b.rating1 - b.rating2) - Math.abs(a.rating1 - a.rating2));

    document.getElementById('filmCompare').textContent = seenByBothRated.length ? seenByBothRated.map(f => `${formatSlug(f.slug)} - Ratings: ${f.rating1} | ${f.rating2}`).join('\n') : 'No se encontraron coincidencias con rating.';

    // Watchlist matches
    const wl1 = watchlistUser1.map(x => x.slug);
    const wl2 = watchlistUser2.map(x => x.slug);
    const wlMatches = wl1.filter(s => wl2.includes(s));
    document.getElementById('watchlistCompare').textContent = wlMatches.length ? wlMatches.map(formatSlug).join('\n') : 'No se encontraron coincidencias en las watchlists.';

    // Películas vistas solo por usuario 1 (con rating o N/A)
    const uniqueToUser1 = seenUser1.filter(s1 => !seenUser2.some(s2 => s2.slug === s1.slug));
    // Películas vistas solo por usuario 2
    const uniqueToUser2 = seenUser2.filter(s2 => !seenUser1.some(s1 => s1.slug === s2.slug));

    uniqueToUser1.sort((a,b) => {
      if(a.rating === 'N/A' && b.rating === 'N/A') return 0;
      if(a.rating === 'N/A') return 1;
      if(b.rating === 'N/A') return -1;
      return b.rating - a.rating;
    });
    uniqueToUser2.sort((a,b) => {
      if(a.rating === 'N/A' && b.rating === 'N/A') return 0;
      if(a.rating === 'N/A') return 1;
      if(b.rating === 'N/A') return -1;
      return b.rating - a.rating;
    });

    document.getElementById('filmSlugs3').textContent = uniqueToUser1.length ? uniqueToUser1.map(f => `${formatSlug(f.slug)} - Rating: ${f.rating}`).join('\n') : `No hay películas vistas por ${username1} que no haya visto ${username2}.`;
    document.getElementById('filmSlugs4').textContent = uniqueToUser2.length ? uniqueToUser2.map(f => `${formatSlug(f.slug)} - Rating: ${f.rating}`).join('\n') : `No hay películas vistas por ${username2} que no haya visto ${username1}.`;

    // Películas que Usuario 1 tiene N/A y Usuario 2 NO tiene (ni vistas ni con rating)
    const naUser1NotUser2 = filmsUser1.filter(f1 => f1.rating === 'N/A' && !filmsUser2.some(f2 => f2.slug === f1.slug));
    document.getElementById('filmSlugsNA').textContent = naUser1NotUser2.length ? naUser1NotUser2.map(f => formatSlug(f.slug)).join('\n') : `No hay películas con N/A para ${username1} que ${username2} no haya visto.`;

    document.getElementById('results').style.display = 'flex';

    setTimeout(() => {
      document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 50);
  }

  function formatFilmSlug(slug, rating){
    return `${formatSlug(slug)} - Rating: ${rating}`;
  }
  function formatSlug(slug){
    if(!slug) return '';
    return slug.replace(/-/g,' ').replace(/\b\w/g, c => c.toUpperCase());
  }
</script>
</body>
</html>
