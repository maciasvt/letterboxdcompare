<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador de Letterboxd</title>
    <style>

        button{
            font-size: 14pt;
            background-color: #00ac1c;
            color:white;
        }
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            color:white;
            background-color: #142428;
            font-family: Arial, Helvetica, sans-serif;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        
        .container {
            display: flex;
            justify-content: center; 
            margin-bottom: 20px; 
        }

        input {
            margin: 0 10px; 
            padding: 10px;
        }

        #filmSlugs1, #filmSlugs2, #filmCompare, #watchlistSlugs1, #watchlistSlugs2, #watchlistCompare {
            border: 1px solid #ccc;
            padding: 10px;
            max-height: 100px;
            overflow-y: auto; 
            white-space: pre-wrap; 
            width: 45%; 
            margin: 10px; 
            text-align: center; 
            background-color: white;
            color:black;
            color:white;
            background-color: #142428;
        }

        .film-container {
            display: flex; 
            justify-content: space-between; 
            width: 100%; 
        }
        
        #codeOutput {
            display: none; 
        }
    </style>
    <script>
        let username1 = '';
        let username2 = '';

        function construirUrlYExtraer() {
            username1 = document.getElementById('username1').value; 
            username2 = document.getElementById('username2').value; 

            // Actualizar los encabezados con los nombres de usuario
            document.getElementById('labelSlugs1').textContent = `Últimas vistas de : ${username1}`;
            document.getElementById('labelSlugs2').textContent = `Últimas vistas de : ${username2}`;
            document.getElementById('labelWatchlistSlugs1').textContent = `Watchlist de : ${username1}`;
            document.getElementById('labelWatchlistSlugs2').textContent = `Watchlist de : ${username2}`;

            const url1 = `https://letterboxd.com/${username1}/films`; 
            const url2 = `https://letterboxd.com/${username2}/films`; 
            const watchlistUrl1 = `https://letterboxd.com/${username1}/watchlist/`; 
            const watchlistUrl2 = `https://letterboxd.com/${username2}/watchlist/`; 

            // Extraer ambos sets de datos en paralelo
            Promise.all([
                extraerHtml(url1, 'filmSlugs1'),
                extraerHtml(url2, 'filmSlugs2'),
                extraerHtmlWatchlist(watchlistUrl1, 'watchlistSlugs1'),
                extraerHtmlWatchlist(watchlistUrl2, 'watchlistSlugs2')
            ]).then(() => {
                compararFilms();
                compararWatchlists();
            });
        }

        async function extraerHtml(url, slugsContainerId) {
            const response = await fetch(`https://letterboxdcompare.onrender.com/extraer?url=${encodeURIComponent(url)}`);
            const html = await response.text();
            const totalPages = encontrarTotalPaginas(html);
            
            let filmData = extraerSlugsConCalificacion(html);

            // Solo buscar más páginas si hay más de una
            if (totalPages > 1) {
                for (let i = 2; i <= totalPages; i++) {
                    const pageUrl = `${url}/page/${i}/`;
                    console.log("url:",pageUrl);
                    const pageResponse = await fetch(`https://letterboxdcompare.onrender.com/extraer?url=${encodeURIComponent(pageUrl)}`);
                    const pageHtml = await pageResponse.text();
                    filmData = filmData.concat(extraerSlugsConCalificacion(pageHtml));
                }
            }

            document.getElementById(slugsContainerId).textContent = filmData.map(film => `${film.slug} - Rating: ${film.rating}`).join('\n');
        }

        async function extraerHtmlWatchlist(url, slugsContainerId) {
            const response = await fetch(`https://letterboxdcompare.onrender.com/extraer?url=${encodeURIComponent(url)}`);
            const html = await response.text();
            const totalPages = encontrarTotalPaginas(html);
            let watchlistData = extraerSlugsWatchlist(html);

            // Solo buscar más páginas si hay más de una
            if (totalPages > 1) {
                for (let i = 2; i <= totalPages; i++) {
                    const pageUrl = `${url}/page/${i}/`;
                    const pageResponse = await fetch(`https://letterboxdcompare.onrender.com/extraer?url=${encodeURIComponent(pageUrl)}`);
                    const pageHtml = await pageResponse.text();
                    watchlistData = watchlistData.concat(extraerSlugsWatchlist(pageHtml));
                }
            }

            document.getElementById(slugsContainerId).textContent = watchlistData.map(film => film.slug).join('\n');
        }

        function encontrarTotalPaginas(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const paginacion = tempDiv.querySelectorAll('.paginate-page');
            const totalPageNumber = paginacion.length > 0 ? paginacion[paginacion.length - 1].textContent : "1";
            return parseInt(totalPageNumber, 10); 
        }

        function extraerSlugsConCalificacion(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            const elementos = tempDiv.querySelectorAll('[data-film-slug]');
            let filmData = [];

            elementos.forEach(elemento => {
                const filmSlug = elemento.getAttribute('data-film-slug'); 
                const ratingElement = elemento.closest('.poster-container').querySelector('.poster-viewingdata .rating');
                const rating = ratingElement ? ratingElement.className.match(/ rated-(\d+)/) : null;
                const filmRating = rating ? rating[1] : "N/A"; 

                filmData.push({ slug: filmSlug, rating: filmRating }); 
            });
            return filmData; 
        }

        function extraerSlugsWatchlist(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            const elementos = tempDiv.querySelectorAll('[data-film-slug]');
            let watchlistData = [];

            elementos.forEach(elemento => {
                const filmSlug = elemento.getAttribute('data-film-slug'); 
                watchlistData.push({ slug: filmSlug }); // Solo guardar el slug
            });
            return watchlistData; 
        }

        function compararFilms() {
            const films1 = document.getElementById('filmSlugs1').textContent.split('\n').map(line => {
                const parts = line.split(' - ');
                return { slug: parts[0].trim(), rating: parts.length > 1 ? parts[1].replace('Rating: ', '').trim() : "N/A" };
            }).filter(film => film.rating !== "N/A");

            const films2 = document.getElementById('filmSlugs2').textContent.split('\n').map(line => {
                const parts = line.split(' - ');
                return { slug: parts[0].trim(), rating: parts.length > 1 ? parts[1].replace('Rating: ', '').trim() : "N/A" };
            }).filter(film => film.rating !== "N/A");

            const coincidencias = films1.filter(film1 => 
                films2.some(film2 => film2.slug === film1.slug)
            ).map(film1 => {
                const film2 = films2.find(f => f.slug === film1.slug);
                return `${film1.slug} - Ratings: ${film1.rating} | ${film2.rating}`;
            });

            console.log("Coincidencias encontradas:", coincidencias);

            document.getElementById('filmCompare').textContent = coincidencias.length > 0 ? coincidencias.join('\n') : "No se encontraron coincidencias.";
        }

        function compararWatchlists() {
            const watchlist1 = document.getElementById('watchlistSlugs1').textContent.split('\n').map(slug => slug.trim()).filter(slug => slug !== "");
            const watchlist2 = document.getElementById('watchlistSlugs2').textContent.split('\n').map(slug => slug.trim()).filter(slug => slug !== "");

            const coincidenciasWatchlist = watchlist1.filter(slug1 => 
                watchlist2.includes(slug1)
            );

            console.log("Coincidencias en la watchlist encontradas:", coincidenciasWatchlist);

            document.getElementById('watchlistCompare').textContent = coincidenciasWatchlist.length > 0 ? coincidenciasWatchlist.join('\n') : "No se encontraron coincidencias en las watchlists.";
        }

    </script>
</head>
<body>
    <h1>Comparador de Letterboxd</h1>
    <div class="container">
        <input type="text" id="username1" placeholder="Usuario 1" />
        <input type="text" id="username2" placeholder="Usuario 2" />
    </div>
    <button onclick="construirUrlYExtraer()">Comparar perfiles y watchlists!</button>

    <div class="film-container">
        <h2 id="labelSlugs1">Últimas vistas de :</h2>
        <h2 id="labelSlugs2">Últimas vistas de :</h2>
    </div>
    
    <div class="film-container">
        <div id="filmSlugs1"></div>
        <div id="filmSlugs2"></div>
    </div>

    <h2>Comparación de vistas y calificadas</h2>
    <div id="filmCompare"></div>

    <div class="film-container">
        <h2 id="labelWatchlistSlugs1">Watchlist de :</h2>
        <h2 id="labelWatchlistSlugs2">Watchlist de :</h2>
    </div>
    
    <div class="film-container">
        <div id="watchlistSlugs1"></div>
        <div id="watchlistSlugs2"></div>
    </div>

    <h2>Comparación de watchlists</h2>
    <div id="watchlistCompare"></div>

    <pre id="codeOutput"></pre>
</body>
</html>




