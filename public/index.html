<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Letterboxd Compare</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #142428;
            font-family: "Roboto", sans-serif;
            color: white;
        }
        h1 {
            font-size: 28px;
            text-align: center;
            margin-bottom: 20px;
        }
        .container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 400px;
            gap: 10px;
            margin-bottom: 15px;
        }
        input {
            font-size: 16px;
            padding: 10px;
            border: none;
            border-radius: 5px;
        }
        button {
            font-size: 18px;
            background-color: #00ac1c;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s, transform 0.2s;
        }
        button:hover {
            background-color: #007a0b;
            transform: translateY(-3px);
        }
        .label, #filmSlugs1, #filmSlugs2, #filmCompare, #watchlistSlugs1, #watchlistSlugs2, 
        #watchlistCompare, #uniqueFilms1, #uniqueFilms2, #filmSlugs3, #filmSlugs4 {
            display: none;
            margin-top: 15px;
            width: 100%;
            max-width: 400px;
            word-wrap: break-word;
        }
        .data-box {
            background: white;
            color: black;
            padding: 10px;
            font-size: 14px;
            border-radius: 5px;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
    <script>
        let username1 = '';
        let username2 = '';

        function construirUrlYExtraer() {
            username1 = document.getElementById('username1').value.trim();
            username2 = document.getElementById('username2').value.trim();

            document.getElementById('labelSlugs1').textContent = `Last seen by: ${username1}`;
            document.getElementById('labelSlugs2').textContent = `Last seen by: ${username2}`;
            document.getElementById('labelWatchlistSlugs1').textContent = `${username1}'s Watchlist`;
            document.getElementById('labelWatchlistSlugs2').textContent = `${username2}'s Watchlist`;

            const url1 = `https://letterboxd.com/${username1}/films`;
            const url2 = `https://letterboxd.com/${username2}/films`;
            const watchlistUrl1 = `https://letterboxd.com/${username1}/watchlist/`;
            const watchlistUrl2 = `https://letterboxd.com/${username2}/watchlist/`;

            Promise.all([
                extraerHtml(url1, 'filmSlugs1').then(() => mostrarElemento('labelSlugs1')),
                extraerHtml(url2, 'filmSlugs2').then(() => mostrarElemento('labelSlugs2')),
                extraerHtmlWatchlist(watchlistUrl1, 'watchlistSlugs1').then(() => mostrarElemento('labelWatchlistSlugs1')),
                extraerHtmlWatchlist(watchlistUrl2, 'watchlistSlugs2').then(() => mostrarElemento('labelWatchlistSlugs2'))
            ]).then(() => {
                compararFilms();
                compararWatchlists();
                compararFilmsUnicos();
            });
        }

        function mostrarElemento(id) {
            document.getElementById(id).style.display = 'block';
        }

        async function extraerHtml(url, containerId) {
            const response = await fetch(`/extraer?url=${encodeURIComponent(url)}`);
            const html = await response.text();
            const totalPages = encontrarTotalPaginas(html);
            let filmData = extraerSlugsConCalificacion(html);

            for (let i = 2; i <= totalPages; i++) {
                const pageResponse = await fetch(`/extraer?url=${encodeURIComponent(`${url}/page/${i}/`)}`);
                const pageHtml = await pageResponse.text();
                filmData = filmData.concat(extraerSlugsConCalificacion(pageHtml));
            }

            document.getElementById(containerId).innerHTML = `<div class="data-box">${filmData.map(f => formatFilmSlug(f.slug, f.rating)).join('\n')}</div>`;
            mostrarElemento(containerId);
        }

        async function extraerHtmlWatchlist(url, containerId) {
            const response = await fetch(`/extraer?url=${encodeURIComponent(url)}`);
            const html = await response.text();
            const totalPages = encontrarTotalPaginas(html);
            let watchlistData = extraerSlugsWatchlist(html);

            for (let i = 2; i <= totalPages; i++) {
                const pageResponse = await fetch(`/extraer?url=${encodeURIComponent(`${url}/page/${i}/`)}`);
                const pageHtml = await pageResponse.text();
                watchlistData = watchlistData.concat(extraerSlugsWatchlist(pageHtml));
            }

            document.getElementById(containerId).innerHTML = `<div class="data-box">${watchlistData.map(f => formatSlug(f.slug)).join('\n')}</div>`;
            mostrarElemento(containerId);
        }

        function encontrarTotalPaginas(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const pages = tempDiv.querySelectorAll('.paginate-page');
            return pages.length > 0 ? parseInt(pages[pages.length - 1].textContent, 10) : 1;
        }

        function extraerSlugsConCalificacion(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const elementos = tempDiv.querySelectorAll('[data-film-slug]');
            let filmData = [];
            elementos.forEach(e => {
                const slug = e.getAttribute('data-film-slug');
                const ratingElement = e.closest('.poster-container').querySelector('.poster-viewingdata .rating');
                const rating = ratingElement ? ratingElement.className.match(/rated-(\d+)/) : null;
                const filmRating = rating ? rating[1] : "N/A";
                filmData.push({ slug, rating: filmRating });
            });
            return filmData;
        }

        function extraerSlugsWatchlist(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const elementos = tempDiv.querySelectorAll('[data-film-slug]');
            return Array.from(elementos).map(e => ({ slug: e.getAttribute('data-film-slug') }));
        }

        function compararFilms() {
            const films1 = getFilteredFilms('filmSlugs1');
            const films2 = getFilteredFilms('filmSlugs2');

            const coincidencias = films1.filter(f1 => films2.some(f2 => f2.slug === f1.slug))
                .map(f1 => {
                    const f2 = films2.find(f => f.slug === f1.slug);
                    return { slug: f1.slug, rating1: parseInt(f1.rating), rating2: parseInt(f2.rating) };
                });

            coincidencias.sort((a, b) => (b.rating1 - b.rating2) - (a.rating1 - a.rating2));

            document.getElementById('filmCompare').innerHTML = `<div class="data-box">${
                coincidencias.length ? coincidencias.map(f => `${f.slug} - Ratings: ${f.rating1} | ${f.rating2}`).join('\n') : "No matches."
            }</div>`;
            mostrarElemento('filmCompare');
            mostrarElemento('labelFilmCompare');
        }

        function compararWatchlists() {
            const wl1 = getSlugList('watchlistSlugs1');
            const wl2 = getSlugList('watchlistSlugs2');

            const matches = wl1.filter(s => wl2.includes(s));
            document.getElementById('watchlistCompare').innerHTML = `<div class="data-box">${
                matches.length ? matches.map(formatSlug).join('\n') : "No matches."
            }</div>`;
            mostrarElemento('watchlistCompare');
            mostrarElemento('labelWatchlistCompare');
        }

        function compararFilmsUnicos() {
            const films1 = getFilteredFilms('filmSlugs1');
            const films2 = getFilteredFilms('filmSlugs2');

            const unique1 = films1.filter(f1 => !films2.some(f2 => f2.slug === f1.slug));
            const unique2 = films2.filter(f2 => !films1.some(f1 => f1.slug === f2.slug));

            unique1.sort((a, b) => b.rating - a.rating);
            unique2.sort((a, b) => b.rating - a.rating);

            document.getElementById('filmSlugs3').innerHTML = `<div class="data-box">${
                unique1.length ? unique1.map(f => `${f.slug} - Rating: ${f.rating}`).join('\n') : `No films seen by ${username1} not by ${username2}.`
            }</div>`;
            document.getElementById('filmSlugs4').innerHTML = `<div class="data-box">${
                unique2.length ? unique2.map(f => `${f.slug} - Rating: ${f.rating}`).join('\n') : `No films seen by ${username2} not by ${username1}.`
            }</div>`;

            mostrarElemento('filmSlugs3');
            mostrarElemento('filmSlugs4');
            mostrarElemento('labelUniqueFilms1');
            mostrarElemento('labelUniqueFilms2');
            document.getElementById('labelUniqueFilms1').textContent = `Seen by ${username1} not by ${username2}`;
            document.getElementById('labelUniqueFilms2').textContent = `Seen by ${username2} not by ${username1}`;
        }

        function getFilteredFilms(containerId) {
            return document.getElementById(containerId).textContent.split('\n')
                .map(line => {
                    const parts = line.split(' - ');
                    return { slug: parts[0].trim(), rating: parts[1] ? parts[1].replace('Rating: ', '').trim() : "N/A" };
                })
                .filter(f => f.rating !== "N/A");
        }

        function getSlugList(containerId) {
            return document.getElementById(containerId).textContent.split('\n').map(s => s.trim()).filter(s => s);
        }

        function formatFilmSlug(slug, rating) {
            return `${slug.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase())} - Rating: ${rating}`;
        }

        function formatSlug(slug) {
            return slug.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        }
    </script>
</head>
<body>
    <h1>Letterboxd Compare</h1>
    <div class="container">
        <input type="text" id="username1" placeholder="User 1">
        <input type="text" id="username2" placeholder="User 2">
        <button onclick="construirUrlYExtraer()">Compare profiles!</button>
    </div>

    <h2 id="labelSlugs1" class="label"></h2>
    <div id="filmSlugs1"></div>
    <h2 id="labelSlugs2" class="label"></h2>
    <div id="filmSlugs2"></div>

    <h2 id="labelFilmCompare" class="label">Seen by both + ratings:</h2>
    <div id="filmCompare"></div>

    <h2 id="labelUniqueFilms1" class="label"></h2>
    <div id="filmSlugs3"></div>
    <h2 id="labelUniqueFilms2" class="label"></h2>
    <div id="filmSlugs4"></div>

    <h2 id="labelWatchlistSlugs1" class="label"></h2>
    <div id="watchlistSlugs1"></div>
    <h2 id="labelWatchlistSlugs2" class="label"></h2>
    <div id="watchlistSlugs2"></div>

    <h2 id="labelWatchlistCompare" class="label">In both watchlists:</h2>
    <div id="watchlistCompare"></div>
</body>
</html>
